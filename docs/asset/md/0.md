# やりたいこと

　自分と取引のあるアドレスを、自分のアイコン中心に円周状に並べたい。これをもってモナコイン取引ユーザ相関図とする。

　取引には支払と受取がある。それぞれの相関図を作りたい。

　でもその前に、どうやってその図を作るかを今ここで考える。

## 方法

* 取引アドレスは[トランザクション取得APIによって入手][]する
* アイコン画像は[mpurseのアドレスとプロフィールを登録する][]によって登録されたデータから取得する

[トランザクション取得APIによって入手]:https://ytyaru.github.io/Html.Mona.Transaction.Viewer.20220620152433/
[mpurseのアドレスとプロフィールを登録する]:https://ytyaru.github.io/Html.GAS.Mastodon.Misskey.Address.Profile.20220620171245/

　あとは取引相手のアドレスと、その人が登録したプロフィール情報を使ってグラフを描けばよい。ここではそのグラフを描く方法を考える。とくに難しいのは円周状に配置するための座標算出である。

# 問題

* どうやって取引ユーザ相関図を作るか
* どうやって画像を円周状に並べるか

方法|問題
----|----
HTMLの`<img>`タグ|座標指定できない。CSSを併用する必要があり冗長になる
Canvas|Canvas APIを勉強せねばならない
SVGの`<image>`タグ|`x`,`y`属性値の値をどうやって算出するか

　SVGテキストを作ることで実現する。これならそのSVGテキストをコピーするだけでどこでも再現可能になる。SVGは以下のようなものになる。

```xml
<svg width="240" height="240">
  <rect x="0" y="0" width="240" height="240" style="fill:green" />
  <defs>
    <style type="text/css"><![CDATA[
      .clip-96{ clip-path: circle(48px at center); }
      .clip-64{ clip-path: circle(32px at center); }
    ]]></style>
  </defs>
  <a href="https://ytyaru.github.io/"><image href="./asset/image/avator.png" width="96" height="96" x="72" y="72" class="clip-96" /></a>
  <a href=""><image href="./asset/image/user/kkrn_icon_user_3_resize_min.svg" width="64" height="64" x="88" y="8" class="clip-64" /></a>
  <a href=""><image href="./asset/image/user/kkrn_icon_user_3_resize_min.svg" width="64" height="64" x="168" y="88" class="clip-64" /></a>
  <a href=""><image href="./asset/image/user/kkrn_icon_user_3_resize_min.svg" width="64" height="64" x="88" y="168" class="clip-64" /></a>
  <a href=""><image href="./asset/image/user/kkrn_icon_user_3_resize_min.svg" width="64" height="64" x="8" y="88" class="clip-64" /></a>
</svg>
```

　CSSで画像を正円にくり抜いている。問題は座標の算出だ。

　円周状に並べるための座標計算がわからない。

　私は算数や数学が大の苦手である。

1. 画像の全体サイズを算出する
2. 取引の中心となるアドレスを画面中央に表示する
3. 2の円周状に真上を始点として時計回りに取引ユーザのアイコンを取引額が多い順に並べる
4. 3の円周状に同様に並べる。ただしアイコンを少し小さくする。以後、これを繰り返す

## 1. 画像の全体サイズを算出する

1. 中央画像サイズ
2. 外周ユーザ数とそれらのサイズ
3. 画像の全体サイズ

項目|数|考え
----|--|----
中央画像サイズ|96px|大きすぎず小さすぎず。スマホでも全体像が表示できそうでPCでも小さすぎず。
外周ユーザ数|256|2^8。このくらい表示できれば、それなりの規模である。ひとまずこれを最大値とする。
外周ユーザ画像サイズ|72,64,48,32,24,20px|中央画像より小さい。外側ほど小さくなる。かつ最小サイズ16px以上。256人分表示できる。
画像の全体サイズ|`376=96+((72+64+48+32+24+20)*2)`|重ならずぴったりくっついた必要最小サイズ

　外周における配置数とサイズ。

配置数|サイズ
------|------
8|72
16|64
32|48
48|32
64|24
88|20

　`256人=8+16+32+48+64+88`。

　はたしてこれで、本当にこのサイズでこの配置数を実現できるのか。わからない。その算出方法があるのか。わからない。

　実際にやってみたら、重なるところもあれば、重ならないところもあった。どうしたら次を算出できるのか、わからない。

* 重ならない最大配置数
* 256人など指定した人数分だけ配置できる外周数や画像サイズ（中心ほど大きい画像サイズ）

　重ならない最大数を算出するには、配置数と画像のサイズがいる。サイズ72pxを8個、円周状に配置したとき、各画像が重なり合わずピッタリとなり合わせになる直径はいくつか。「中央画像サイズ/2＋外側１の画像サイズ」で算出できる。でも直径がわかっても目的は達せられなそう。円周の長さが必要なのか？　そこから隣り合う円同士の距離が、自身の長さと同じであればいい。どうやってその距離を算出すればいいのか。わからん。

## 2. 取引の中心となるアドレスを画面中央に表示する

1. 画面中央の座標を算出する
2. 画像を表示する始点である左上座標を算出する

```javascript
const cw = 画像全体の幅 / 2
const ch = 画像全体の高さ / 2
```
```javascript
const left = (画像全体の幅 / 2) - (アイコンの幅 / 2)
const top = (画像全体の高さ / 2) - (アイコンの高さ / 2)
```
```html
<svg>
  <image x="${left}" y="${top}" />
</svg>
```

　画像全体サイズ240px、アイコン画像96pxとしたとき、アイコンを中央に表示する座標はいくつか？

```javascript
const cw = 240 / 2
const ch = 240 / 2
const left = cw - (96 / 2)
const top = ch - (96 / 2)
```
```
left = 120 - 48 = 72
```
```html
<svg>
  <image x="72" y="72" />
</svg>
```

### 2-1. アイコンを円形にクリッピングする

```xml
<svg width="240" height="240">
  <rect x="0" y="0" width="240" height="240" style="fill:green" />
  <defs>
    <style type="text/css"><![CDATA[
      .clip-96 { clip-path: circle(48px at center); }
    ]]></style>
  </defs>
  <a href="https://ytyaru.github.io/"><image href="./asset/image/avator.png" width="96" height="96" x="72" y="72" class="clip-96"/></a>
</svg>
```

　ポイントは以下CSSである。`clip-path`で画像を指定したパスにもとづき切り抜く。そのパスは`circle()`関数で指定する。引数は半径と座標。96pxの矩形画像を、半径48pxの正円で切り抜く。

```css
.clip-96 { clip-path: circle(48px at center); }
```

## 3. 2の円周状に真上を始点として時計回りに取引ユーザのアイコンを取引額が多い順に並べる

* [円周上に要素を配置したい、配置はできたが傾いているのでバランスを整えたい - taratail][]

[円周上に要素を配置したい、配置はできたが傾いているのでバランスを整えたい - taratail]:https://teratail.com/questions/376112?rss=all

　以下のようにすることで、真上から時計回りに画像を配置できるっぽい。

```javascript
var x = Math.cos(red * i - Math.PI/2) * circle_r + circle_r;
var y = Math.sin(red * i - Math.PI/2) * circle_r + circle_r;
```

　サイン・コサイン・タンジェント。三角関数。うっ、頭が……。頭痛が痛い。思い、出せない！　そもそも中学生の当時で理解できていなかった。今も理解できない。角度が関係あったような気がする。変数名から察するに、角度から座標を算出しているのだろう。

　あと、`Math.PI/2`は90度のことらしい。`PI`は円周率。なぜそれを`2`で割ると`90`度なの？　たしか角度の指標は２種類あったはず。ググると以下のとおり。

表記|読み|和名|値
----|----|----|--
`deg`|デグリー|度数法|`0`〜`360`
`rad`|ラジアン|弧度法|`1`rad=`57.3`deg

　`deg`は分度器のやつだからわかる。でも`rad`がわからん。たぶんそれがサイン・コサイン・タンジェントなんだろう。

> 弧度(`rad`)は、2本の半径および半径と同じ長さの弧が成す角度です。

* [角度の単位とdegは？1分でわかる意味、°、radとの関係、ラジアンの表][]
* [弧度とは？1分でわかる意味、読み方、ラジアン、角度との関係][]

[角度の単位とdegは？1分でわかる意味、°、radとの関係、ラジアンの表]:http://kentiku-kouzou.jp/suugaku-kakudotanideg.html
[弧度とは？1分でわかる意味、読み方、ラジアン、角度との関係]:http://kentiku-kouzou.jp/kouzoukeisan-kodo.html

　これを1分で理解できる人は数学マイスターに違いない。私には無理だ。以下の式の一発目からわからない。

```
ｒ：２πr＝α：360
ｒ×360＝２πrα
α＝360ｒ/2πr＝180／π＝57.3（※π＝3.14）
```

　`ｒ：２πr＝α：360`ってなんだよ。

* `r`は円の半径。
* `π`は円周率`3.14`
* `α`は求めたい答え。弧度(`rad`)。2本の半径および半径と同じ長さの弧が成す角度
* `2`倍しているのは`r`、つまり直径
* 直径×円周率`3.14`は円周（円の外側の長さ）
* `360`は円の角度

　それぞれの値や記号、式の意味はわかった。でも`:`ってなに？　`:`はたしか比だと思う。`1:3`なら右は左の三倍。`1:3=ザク:シャア専用ザク`ということになるはず。`ザク3機＝シャア専用ザク1機`ということ。シャア専用ザクはザクの三倍の性能だから三機分と同じだと換算できる。それをあらわした式である。

　こうして考えると、左側の`1:3`は機数で、右側は機種をあらわしている。つまり同じ単位でなければ成立しない。そこで例の式をみてみると、左側は`ｒ：２πr`、右側は`α：360`である。左側の`ｒ`は半径であり長さ。左側の右`２πｒ`は円周の長さ。どちらも長さだけど、半径は中点から外側までの長さであり、円周は円の外側の長さ。どうしてこれらを比較できるのかわからない。さっきのザクの機数とぜんぜん違うと思う。もしそのやり方がいいなら、ザクの機数とザクがもっているビームサーベル数を比較してしまうようなものに思える。あ、これ「弧の長さが半径`ｒ`と同じとき」の話だったか。じゃあいいのか。

　右側の`α：360`にある`α`はラジアン角度であり、`360`はデグリー角度。異なる度法なのに、どうして比較できるのかわからない。方法の違いはあくまで見方であって、絶対的な物理的違いではないから同じとみなして比較できるということか？　でも、そもそも`α`は「2本の半径および半径と同じ長さの弧が成す角度」である。なんでその条件のときの角度を知ろうと思ったの？　なんでその条件のときの角度と`360`度が比較できるの？　ピンとこない。

　とにかく、ある長さのとき、ある角度になる。それを意味する式なのだろう。円周が`２πｒ`のとき角度は`360`になる。それはわかる。正円の円周は直径×円周率でありそれが`２πｒ`。そして正円の内角は360度。なるほど、正円のときの円周と内角における関係式か。そこまではわかった。じゃあ、なぜ、弧の長さが半径`ｒ`のときの角度を求めようとするの？　ああ、そうすることで、`２πｒ＝360`と比較でき、その比の式から弧の長さが半径`ｒ`のときの角度が求まるからか。どうにか関係づけることで算出したくて、そういう条件にしただけなのか。

　で、弧の長さが`ｒ`のときその内角`α`が求まったら、何が嬉しいの？　たぶんその角度をもちいて、円周上の座標を算出できるのだろう。それがサイン・コサイン・タンジェントなのだろう。そこはよくわからないが、もういい。限界だ。残念なことに、ここまでのことは小学生レベルの話だと思う。私の限界だよ。

　コードに戻ろう。

　`red`や`i`の意味は質問元の以下コードで予測できる。

```javascript
$(function(){
var item_num = $('div.item').length;
var deg = 360.0/item_num;
var red = (deg*Math.PI/180.0);
var circle_r = $("div.item").width() * 1.3;
$('div.item').each(function(i, elem) {
var x = Math.cos(red * i) * circle_r + circle_r;
var y = Math.sin(red * i) * circle_r + circle_r;
$(elem).css('left', x);
$(elem).css('top', y);
});
});
```

変数|意味
----|----
`item_num`|円周状に表示したい画像数
`deg`|画像ひとつあたり何度ごとに配置するか
`red`|？　たぶん算数や数学の知識がいる。質問元をみるに中央の真上にある赤い円のことだろう。ただその円の何を示しているのかわからない。配置する角度かな？
`circle_r`|？　たしか数学で半径を`r`で表現していたような。でも直径`width`を`1.3`倍しているのが謎。半径×半径×`3.14`は円の体積だっけ？　それは関係ないか。直径×`3.14`は円周（外周の長さ）だっけ？　そういえばゆとり教育では円周率って`3`だっけ。でも`1.3`倍は関係ないと思うし。わからん。
`i`|配置する画像のインデックス。何番目の画像か。それによって角度・座標が変わる。

## 4. 3の円周状に同様に並べる。ただしアイコンを少し小さくする。以後、これを繰り返す

画像|サイズ|数|位置
----|------|--|----
中央画像サイズ|96|1|中央
外周１画像サイズ|72|8|四方八方
外周２画像サイズ|64|16|四方八方
外周３画像サイズ|48|32|四方八方

　こんなふうに配置するのだとしたら、各外周位置にある画像の開始位置はどうやって算出すればいいのか。答えは以下。画像全体の中央から、その外周位置にある画像を円形にならべた図の矩形サイズを差し引いた位置。つまり中央位置に配置するための左上座標。

```javascript
const leftTop = center - ((this.userIconSizes[0]/2) + this.userIconSizes.slice(1,i+2).reduce((sum,v)=>sum+v))
```

　`r`は数学でいう半径だと思う。`r`の値を変えると、円周上に配置する大きな円の大きさが変わるため、たぶん半径という認識でいいはず。あとはそれのサイズを算出すればいい。

　最初はどう計算したらいいかわからず適当に数値を入れて確認していた。それを何度もくりかえし、そこから予測して、以下のような式にたどりついた。数学とは気合いで解くものであり、世の中の全ては根性論で証明できる。
　
```javascript
const r = ((this.userIconSizes[0]+this.userIconSizes[i+1])/2) + ((0==middles.length) ? 0 : middles.reduce((sum,v)=>sum+v))
```

　つまり中央画像と今表示している画像のサイズは半分に割る。それらの中間にある外周位置の画像たちが存在すれば、それらのサイズを足す。なんか知らんけど、そうやればピッタリ外や内との外周と重ならない位置の大きさになるっぽい。なんでだろう。

　ポイントは中央画像と今表示している画像のサイズを半分にしているところかな。もし円サイズ、つまり直径を求めるなら、各外周位置にあるアイコン画像サイズを合計すればいいだけのはず。なのに最初と最後の位置にある画像は半分にしている。それはつまり、中央位置ということなのだろう。いまいち頭の中できちんとイメージしきれないし、理解できていなさそう。それを伝えられる数学の知識もない。

　まあいいや。それっぽく表示できているし。

　あとは以下のようにすればいい。ググった式に、初期位置を足してやる。

```javascript
const x = Math.cos(start * i - Math.PI / 2) * r + r + leftTop;
const y = Math.sin(start * i - Math.PI / 2) * r + r + leftTop;
```

　この`x`と`y`はSVGの`<image>`タグがもつ`x`,`y`属性値になる。これらはその画像を表示する始点、つまり左上座標である。

